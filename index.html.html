<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcGenesis - NFT Market</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');
        body { font-family: 'Rajdhani', sans-serif; background-color: #050505; color: #e2e8f0; }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        .neon-box { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(6, 182, 212, 0.3); box-shadow: 0 0 15px rgba(6, 182, 212, 0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #06b6d4; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="border-b border-gray-800 bg-black/90 backdrop-blur sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-cyber text-cyan-400 tracking-wider">ArcMarket</h1>
            <button id="connectBtn" onclick="connectWallet()" class="px-6 py-2 border border-cyan-500 text-cyan-400 rounded hover:bg-cyan-500/10 transition-all font-bold cursor-pointer">Connect Wallet</button>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-12 space-y-16">
        <section class="max-w-xl mx-auto">
            <div class="neon-box p-8 rounded-2xl backdrop-blur-md">
                <h2 class="text-3xl font-cyber text-white mb-6 text-center">Create NFT</h2>
                
                <div class="space-y-5">
                    
                    <!-- ·Éê·É†·É©·Éî·Éï·Éê·Éú·Éò: ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éê·Éú ·Éö·Éò·Éú·Éô·Éò -->
                    <div class="flex gap-4 mb-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="imgMode" value="upload" checked onclick="toggleMode()" class="accent-cyan-500">
                            <span class="text-sm text-gray-300">Upload File</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="imgMode" value="url" onclick="toggleMode()" class="accent-cyan-500">
                            <span class="text-sm text-gray-300">Paste URL</span>
                        </label>
                    </div>

                    <!-- 1. ·É§·Éê·Éò·Éö·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê -->
                    <div id="uploadBox">
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-900/50 file:text-cyan-400 cursor-pointer bg-black/50 rounded-lg border border-gray-700 p-2"/>
                    </div>

                    <!-- 2. ·Éö·Éò·Éú·Éô·Éò·É° ·É©·Éê·É°·Éõ·Éê (·Éì·Éê·Éõ·Éê·Éö·É£·Éö·Éò·Éê ·Éó·Éê·Éï·Éò·Éì·Éê·Éú) -->
                    <div id="urlBox" class="hidden">
                        <input type="text" id="imageUrlInput" placeholder="Paste image link here (https://...)" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-cyan-500">
                    </div>

                    <div>
                        <label class="block text-gray-400 mb-2 text-sm uppercase">NFT Name</label>
                        <input type="text" id="nftName" placeholder="Enter NFT Name" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-cyan-500">
                    </div>

                    <div>
                        <label class="block text-gray-400 mb-2 text-sm uppercase">Price (USDC)</label>
                        <div class="relative">
                            <input type="number" id="nftPrice" placeholder="0.00" step="0.01" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:border-cyan-500 pl-4">
                            <span class="absolute right-4 top-3 text-gray-500 text-sm font-bold text-cyan-500">USDC</span>
                        </div>
                    </div>

                    <div id="mintLoader" class="loader"></div>
                    <button onclick="createAndPublish()" class="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-lg uppercase tracking-wider transition-all shadow-[0_0_15px_rgba(6,182,212,0.4)] cursor-pointer">
                        Publish to Marketplace
                    </button>
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-2xl font-cyber text-white mb-8 border-b border-gray-800 pb-4">Live Mints</h3>
            <div id="nftGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-gray-500 col-span-full text-center py-10">Connect wallet to view NFTs...</div>
            </div>
        </section>
    </main>

    <script>
        // ·Éê·ÉÆ·Éê·Éö·Éò API Key (·Éò·Éõ·Éî·Éì·Éò·Éê ·Éò·Éõ·É£·É®·Éê·Éï·Éî·Éë·É°)
        const IMGBB_API_KEY = "c87eb762b7816823c914b4f653457a44"; 
        const marketplaceAddress = "0x8e6fD58c5FB124BB884BF2888a3D826Fdb302C1F";

        const marketplaceABI = [
            "function createToken(string memory tokenURI, uint256 price) public payable returns (uint)",
            "function getAllNFTs() public view returns (tuple(uint256 tokenId, address seller, address owner, uint256 price, bool sold, string tokenURI)[])",
            "function buyItem(uint256 tokenId) public payable"
        ];

        let provider, signer, contract;
        let isConnected = false;

        function toggleMode() {
            const mode = document.querySelector('input[name="imgMode"]:checked').value;
            if(mode === 'upload') {
                document.getElementById('uploadBox').classList.remove('hidden');
                document.getElementById('urlBox').classList.add('hidden');
            } else {
                document.getElementById('uploadBox').classList.add('hidden');
                document.getElementById('urlBox').classList.remove('hidden');
            }
        }

        async function connectWallet() {
            if (typeof ethers === 'undefined') return alert("Ethers.js loading...");
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    document.getElementById("connectBtn").innerText = accounts[0].slice(0,6) + "...";
                    isConnected = true;
                    contract = new ethers.Contract(marketplaceAddress, marketplaceABI, signer);
                    loadNFTs();
                } catch (err) { alert("Error: " + err.message); }
            } else { alert("Install MetaMask!"); }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                let res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                let data = await res.json();
                if(data.success) return data.data.url;
                else throw new Error(data.error.message);
            } catch (err) {
                console.error(err);
                alert("Upload Failed: " + err.message + "\nTry using 'Paste URL' mode instead.");
                return null;
            }
        }

        async function createAndPublish() {
            if (!isConnected) return alert("Connect Wallet first!");
            
            const mode = document.querySelector('input[name="imgMode"]:checked').value;
            const name = document.getElementById("nftName").value;
            const priceVal = document.getElementById("nftPrice").value;
            
            let imageUrl = "";

            // ·Éö·Éù·Éí·Éò·Éô·Éê: ·Éê·Éú ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éê·Éú ·Éö·Éò·Éú·Éô·Éò
            if (mode === 'upload') {
                const fileInput = document.getElementById("imageInput");
                if (!fileInput.files[0]) return alert("·Éê·Éò·É†·É©·Éò·Éî ·É°·É£·É†·Éê·Éó·Éò!");
                
                document.getElementById("mintLoader").style.display = "block";
                imageUrl = await uploadImage(fileInput.files[0]);
                if (!imageUrl) {
                    document.getElementById("mintLoader").style.display = "none";
                    return; // ·É®·Éî·É¨·Éß·Éï·Éî·É¢·Éê ·Éó·É£ ·Éï·Éî·É† ·Éê·Éò·É¢·Éï·Éò·É†·Éó·Éê
                }
            } else {
                imageUrl = document.getElementById("imageUrlInput").value;
                if (!imageUrl) return alert("·É©·Éê·É¨·Éî·É†·Éî ·É°·É£·É†·Éê·Éó·Éò·É° ·Éö·Éò·Éú·Éô·Éò!");
            }

            if (!name || !priceVal) {
                document.getElementById("mintLoader").style.display = "none";
                return alert("·É®·Éî·Éê·Éï·É°·Éî ·Éß·Éï·Éî·Éö·Éê ·Éï·Éî·Éö·Éò!");
            }

            const loader = document.getElementById("mintLoader");
            loader.style.display = "block";

            try {
                const priceWei = ethers.utils.parseEther(priceVal.toString());
                const listingFee = ethers.utils.parseEther("0.0025"); 

                console.log("Minting:", imageUrl);
                const tx = await contract.createToken(imageUrl, priceWei, { value: listingFee });
                await tx.wait();

                alert("NFT Created! üéâ");
                document.getElementById("nftName").value = "";
                document.getElementById("nftPrice").value = "";
                document.getElementById("imageInput").value = "";
                document.getElementById("imageUrlInput").value = "";
                loadNFTs();

            } catch (err) {
                console.error("Mint Error:", err);
                alert("Error: " + (err.data?.message || err.message));
            } finally {
                loader.style.display = "none";
            }
        }

        async function loadNFTs() {
            if (!contract) return;
            try {
                const items = await contract.getAllNFTs();
                const grid = document.getElementById("nftGrid");
                grid.innerHTML = "";
                if (items.length === 0) return grid.innerHTML = '<div class="text-gray-500 col-span-full text-center">No NFTs yet.</div>';

                items.forEach(item => {
                    if (item.sold) return;
                    const priceDisplay = ethers.utils.formatEther(item.price);
                    grid.innerHTML += `
                        <div class="neon-box rounded-xl overflow-hidden flex flex-col bg-black">
                            <div class="h-64 overflow-hidden relative">
                                <img src="${item.tokenURI}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
                            </div>
                            <div class="p-4 flex flex-col gap-3">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-white font-bold truncate pr-2">#${item.tokenId}</h4>
                                    <span class="text-cyan-400 font-cyber font-bold">${priceDisplay} USDC</span>
                                </div>
                                <button onclick="mintItem('${item.tokenId}', '${priceDisplay}')" class="w-full py-2 bg-white text-black font-bold rounded hover:bg-cyan-400 transition-colors uppercase tracking-wider text-sm mt-2 cursor-pointer">MINT NOW</button>
                            </div>
                        </div>`;
                });
            } catch (err) { console.error(err); }
        }

        async function mintItem(tokenId, priceEth) {
            if (!isConnected) return alert("Connect Wallet!");
            try {
                const priceWei = ethers.utils.parseEther(priceEth);
                const btn = event.target;
                btn.innerText = "WAIT...";
                btn.disabled = true;
                const tx = await contract.buyItem(tokenId, { value: priceWei });
                await tx.wait();
                alert("Sold! üéâ");
                loadNFTs();
            } catch (err) {
                alert("Error: " + err.message);
                event.target.innerText = "MINT NOW";
                event.target.disabled = false;
            }
        }
    </script>
</body>
</html>